---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
---

<Layout title="Secure Cannabis Checkout Australia | Buy Weed Online | Mullaways" description="Complete your weed order securely. Buying weed online in Australia made easy. Bitcoin or bank transfer. Discreet Australia-wide delivery. Express shipping available.">
  <Header />

  <main>
    <Breadcrumb items={[{label: 'Home', href: '/'}, {label: 'Cart', href: '/cart'}, {label: 'Checkout'}]} />
    <section class="page-hero">
      <div class="hero-bg">
        <div class="hero-shape hero-shape-1"></div>
        <div class="hero-shape hero-shape-2"></div>
      </div>
      <div class="container">
        <div class="hero-content">
          <span class="section-label section-label-light">Checkout</span>
          <h1>Secure Checkout</h1>
          <p>Choose delivery and payment, then place your order.</p>
        </div>
      </div>
    </section>

    <section class="section checkout-section">
      <div class="container">
        <div class="checkout-layout" id="checkout-layout">
          <div class="checkout-form" id="checkout-form">
            <div class="card">
              <h2>Delivery Details</h2>
              <form class="form-grid" id="checkout-details">
                <div class="form-group">
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
                </div>
                <div class="form-group">
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
                </div>
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" name="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group full">
                  <label for="address">Street Address</label>
                  <input type="text" id="address" name="address" placeholder="Street address" required>
                </div>
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" placeholder="City" required>
                </div>
                <div class="form-group">
                  <label for="state">State</label>
                  <input type="text" id="state" name="state" placeholder="State" required>
                </div>
                <div class="form-group">
                  <label for="postcode">Postcode</label>
                  <input type="text" id="postcode" name="postcode" placeholder="Postcode" required>
                </div>
              </form>
            </div>

            <div class="card">
              <h2>Delivery Method</h2>
              <div class="option-list" id="delivery-options">
                <label class="option-card">
                  <input type="radio" name="delivery" value="standard" data-fee="9.95" checked>
                  <div>
                    <span class="option-title">Standard Delivery</span>
                    <span class="option-meta">2â€“5 business days Â· $9.95</span>
                  </div>
                </label>
                <label class="option-card">
                  <input type="radio" name="delivery" value="express" data-fee="19.95">
                  <div>
                    <span class="option-title">Express Delivery</span>
                    <span class="option-meta">1â€“2 business days Â· $19.95</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="card">
              <h2>Payment Method</h2>
              <div class="option-list" id="payment-options">
                <label class="option-card">
                  <input type="radio" name="payment" value="bitcoin" checked>
                  <div>
                    <span class="option-title">Bitcoin (Online)</span>
                    <span class="option-meta">Instant confirmation after payment</span>
                  </div>
                </label>
                <label class="option-card">
                  <input type="radio" name="payment" value="bank">
                  <div>
                    <span class="option-title">Bank Transfer (Offline)</span>
                    <span class="option-meta">Manual confirmation after transfer</span>
                  </div>
                </label>
              </div>

              <div class="payment-panel" id="bitcoin-panel">
                <div class="panel-header">
                  <h3>Pay with Bitcoin</h3>
                  <p>Scan the QR code or copy the address below.</p>
                </div>
                <div class="qr-layout">
                  <img class="qr-image" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=bitcoin:bc1q9u4m8xj6z2s8n3m5s2m9vte0y6q5k9w8v4w0v5" alt="Bitcoin payment QR code for Mullaways Medical Cannabis checkout" width="180" height="180" loading="lazy">
                  <div class="qr-details">
                    <div class="qr-field">
                      <span>Bitcoin Address</span>
                      <code>bc1q9u4m8xj6z2s8n3m5s2m9vte0y6q5k9w8v4w0v5</code>
                    </div>
                    <p class="helper">Send the exact total shown in your order summary.</p>
                  </div>
                </div>
              </div>

              <div class="payment-panel" id="bank-panel" style="display: none;">
                <div class="panel-header">
                  <h3>Bank Transfer Instructions</h3>
                  <p>Place your order, then complete the transfer using the details below.</p>
                </div>
                <div class="bank-details">
                  <div>
                    <span>Account Name</span>
                    <strong>Mullaways Medical Pty Ltd</strong>
                  </div>
                  <div>
                    <span>BSB</span>
                    <strong>062-000</strong>
                  </div>
                  <div>
                    <span>Account Number</span>
                    <strong>1234 5678</strong>
                  </div>
                  <div>
                    <span>Reference</span>
                    <strong>Order Email + Last Name</strong>
                  </div>
                </div>
                <div class="info-alert">
                  After placing your order, make the transfer to the bank account above and email a screenshot of the payment to <a href="mailto:payments@mullawaysmedicalcannabis.com.au">payments@mullawaysmedicalcannabis.com.au</a>.
                </div>
              </div>
            </div>
          </div>

          <aside class="checkout-summary" id="checkout-summary">
            <div class="summary-card">
              <h3>Order Summary</h3>
              <div id="summary-items" class="summary-items"></div>
              <div class="summary-row">
                <span>Subtotal</span>
                <span id="summary-subtotal">$0.00</span>
              </div>
              <div class="summary-row">
                <span>Delivery</span>
                <span id="summary-shipping">$0.00</span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-row summary-total">
                <span>Total</span>
                <span id="summary-total">$0.00</span>
              </div>
              <button class="btn btn-primary btn-large btn-full" id="place-order-btn">Place Order</button>
              <p class="secure-note">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0110 0v4"/>
                </svg>
                Secure checkout with encrypted payment
              </p>
            </div>
          </aside>
        </div>

        <div class="empty-state" id="checkout-empty" style="display: none;">
          <div class="empty-icon">ðŸ›’</div>
          <h2>Your cart is empty</h2>
          <p>Add products to your cart before checking out.</p>
          <a href="/shop" class="btn btn-primary">Browse Products</a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  .page-hero {
    position: relative;
    background: linear-gradient(135deg, var(--color-eucalyptus-dark) 0%, var(--color-eucalyptus) 100%);
    padding: var(--space-3xl) 0;
    text-align: center;
    overflow: hidden;
  }

  .hero-bg {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .hero-shape {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
  }

  .hero-shape-1 {
    width: 320px;
    height: 320px;
    top: -80px;
    right: -80px;
  }

  .hero-shape-2 {
    width: 240px;
    height: 240px;
    bottom: -60px;
    left: -60px;
  }

  .hero-content {
    position: relative;
    z-index: 1;
  }

  .section-label-light {
    color: rgba(255, 255, 255, 0.8);
  }

  .section-label-light::before {
    background: rgba(255, 255, 255, 0.5);
  }

  .page-hero h1 {
    color: white;
  }

  .page-hero p {
    color: rgba(255, 255, 255, 0.8);
  }

  .checkout-section {
    padding: 60px 0 90px;
    background: #fff;
  }

  .checkout-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(280px, 0.8fr);
    gap: 32px;
    align-items: start;
  }

  .card {
    background: #fff;
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.04);
    margin-bottom: 24px;
  }

  .card h2 {
    margin: 0 0 16px;
    font-size: 1.4rem;
    color: #1a1a1a;
  }

  .form-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full {
    grid-column: 1 / -1;
  }

  label {
    font-weight: 600;
    color: #1a1a1a;
  }

  input {
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #d8d8d8;
    font-size: 0.95rem;
  }

  .option-list {
    display: grid;
    gap: 12px;
  }

  .option-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px 16px;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .option-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.04);
  }

  .option-card input {
    margin: 0;
  }

  .option-title {
    display: block;
    font-weight: 600;
    color: #1a1a1a;
  }

  .option-meta {
    display: block;
    font-size: 0.85rem;
    color: #666;
  }

  .payment-panel {
    margin-top: 18px;
    padding: 18px;
    border-radius: 14px;
    background: #f9faf8;
    border: 1px solid var(--color-border);
  }

  .panel-header h3 {
    margin: 0 0 6px;
  }

  .panel-header p {
    margin: 0 0 16px;
    color: #666;
  }

  .qr-layout {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  .qr-image {
    width: 180px;
    height: 180px;
    border-radius: 12px;
    border: 1px solid #e2e2e2;
    background: #fff;
  }

  .qr-details {
    flex: 1;
    min-width: 180px;
  }

  .qr-field span {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 6px;
  }

  .qr-field code {
    display: block;
    font-size: 0.9rem;
    background: #fff;
    border: 1px solid #e2e2e2;
    padding: 10px 12px;
    border-radius: 10px;
    word-break: break-all;
  }

  .helper {
    margin-top: 10px;
    font-size: 0.85rem;
    color: #666;
  }

  .bank-details {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .bank-details span {
    display: block;
    font-size: 0.85rem;
    color: #666;
  }

  .bank-details strong {
    color: #1a1a1a;
  }

  .info-alert {
    background: #fff4e5;
    border: 1px solid #f0c88b;
    padding: 14px;
    border-radius: 12px;
    color: #5c3d06;
    font-size: 0.9rem;
  }

  .checkout-summary {
    position: sticky;
    top: 110px;
  }

  .summary-card {
    background: #fff;
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.05);
  }

  .summary-items {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    color: #555;
  }

  .summary-divider {
    height: 1px;
    background: #eee;
    margin: 16px 0;
  }

  .summary-total {
    font-weight: 700;
    color: #1a1a1a;
  }

  .secure-note {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #666;
    margin-top: 14px;
  }

  .empty-state {
    text-align: center;
    padding: 48px;
    border: 1px dashed #ddd;
    border-radius: 16px;
    margin-top: 24px;
  }

  .empty-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
  }

  @media (max-width: 960px) {
    .checkout-layout {
      grid-template-columns: 1fr;
    }

    .checkout-summary {
      position: static;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .bank-details {
      grid-template-columns: 1fr;
    }

    .qr-layout {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .qr-details {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-hero h1 {
      font-size: 1.75rem;
    }

    .card {
      padding: 16px;
    }

    .card h2 {
      font-size: 1.2rem;
    }

    .qr-image {
      width: 150px;
      height: 150px;
    }

    .option-card {
      padding: 12px;
    }

    .summary-card {
      padding: 16px;
    }
  }
</style>

<script>
  // @ts-nocheck
  const cart = JSON.parse(localStorage.getItem('cart') || '[]')
    .filter((/** @type {{ name: string, price: number, quantity: number }} */ item) => item && item.name);

  const checkoutLayout = document.getElementById('checkout-layout');
  const checkoutEmpty = document.getElementById('checkout-empty');
  const summaryItems = document.getElementById('summary-items');
  const summarySubtotal = document.getElementById('summary-subtotal');
  const summaryShipping = document.getElementById('summary-shipping');
  const summaryTotal = document.getElementById('summary-total');
  const placeOrderBtn = document.getElementById('place-order-btn');

  const bitcoinPanel = document.getElementById('bitcoin-panel');
  const bankPanel = document.getElementById('bank-panel');

  function getShippingFee() {
    const selected = document.querySelector('input[name="delivery"]:checked');
    if (!(selected instanceof HTMLInputElement)) return 0;
    return Number(selected.dataset.fee || '0');
  }

  function renderSummary() {
    if (!summaryItems || !summarySubtotal || !summaryShipping || !summaryTotal) return;

    const subtotal = cart.reduce(
      (/** @type {number} */ sum, /** @type {{ name: string, price: number, quantity: number }} */ item) => sum + (item.price * item.quantity),
      0
    );
    const shipping = getShippingFee();
    const total = subtotal + shipping;

    summaryItems.innerHTML = cart.map((/** @type {{ name: string, price: number, quantity: number }} */ item) => `
      <div class="summary-item">
        <span>${item.name} Ã— ${item.quantity}</span>
        <strong>$${(item.price * item.quantity).toFixed(2)}</strong>
      </div>
    `).join('');

    summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
    summaryShipping.textContent = `$${shipping.toFixed(2)}`;
    summaryTotal.textContent = `$${total.toFixed(2)}`;
  }

  function togglePaymentPanels() {
    const selectedPaymentEl = document.querySelector('input[name="payment"]:checked');
    if (!(selectedPaymentEl instanceof HTMLInputElement)) return;
    const selectedPayment = selectedPaymentEl.value;

    if (selectedPayment === 'bank') {
      if (bankPanel) bankPanel.style.display = 'block';
      if (bitcoinPanel) bitcoinPanel.style.display = 'none';
    } else {
      if (bankPanel) bankPanel.style.display = 'none';
      if (bitcoinPanel) bitcoinPanel.style.display = 'block';
    }
  }

  if (cart.length === 0) {
    if (checkoutLayout) checkoutLayout.style.display = 'none';
    if (checkoutEmpty) checkoutEmpty.style.display = 'block';
  } else {
    renderSummary();
  }

  document.querySelectorAll('input[name="delivery"]').forEach((input) => {
    input.addEventListener('change', renderSummary);
  });

  document.querySelectorAll('input[name="payment"]').forEach((input) => {
    input.addEventListener('change', togglePaymentPanels);
  });

  placeOrderBtn?.addEventListener('click', () => {
    const selectedPaymentEl = document.querySelector('input[name="payment"]:checked');
    const selectedPayment = selectedPaymentEl instanceof HTMLInputElement ? selectedPaymentEl.value : '';
    if (selectedPayment === 'bank') {
      alert('Order placed. Please complete the bank transfer and email a screenshot of the payment to payments@mullawaysmedicalcannabis.com.au.');
    } else {
      alert('Order placed. Please complete the bitcoin payment using the QR code or address provided.');
    }
  });
</script>
