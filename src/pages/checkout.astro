---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
---

<Layout title="Secure Checkout | Mullaways Medical Cannabis" description="Complete your cannabis order securely. Pay with Bitcoin, bank transfer or Paysafecard. Discreet Australia-wide delivery with express shipping." noindex={true}>
  <Header />

  <main>
    <Breadcrumb items={[{label: 'Home', href: '/'}, {label: 'Cart', href: '/cart'}, {label: 'Checkout'}]} />
    <section class="page-hero">
      <div class="hero-bg">
        <div class="hero-shape hero-shape-1"></div>
        <div class="hero-shape hero-shape-2"></div>
      </div>
      <div class="container">
        <div class="hero-content">
          <span class="section-label section-label-light">Checkout</span>
          <h1>Secure Checkout</h1>
          <p>Choose delivery and payment, then place your order.</p>
        </div>
      </div>
    </section>

    <section class="section checkout-section">
      <div class="container">
        <div class="checkout-layout" id="checkout-layout">
          <div class="checkout-form" id="checkout-form">
            <div class="card">
              <h2>Delivery Details</h2>
              <form class="form-grid" id="checkout-details">
                <div class="form-group">
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
                </div>
                <div class="form-group">
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
                </div>
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" name="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group full">
                  <label for="address">Street Address</label>
                  <input type="text" id="address" name="address" placeholder="Street address" required>
                </div>
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" placeholder="City" required>
                </div>
                <div class="form-group">
                  <label for="state">State</label>
                  <input type="text" id="state" name="state" placeholder="State" required>
                </div>
                <div class="form-group">
                  <label for="postcode">Postcode</label>
                  <input type="text" id="postcode" name="postcode" placeholder="Postcode" required>
                </div>
              </form>
            </div>

            <div class="card">
              <h2>Delivery Method</h2>
              <div class="option-list" id="delivery-options">
                <label class="option-card">
                  <input type="radio" name="delivery" value="standard" data-fee="9.95" checked>
                  <div>
                    <span class="option-title">Standard Delivery</span>
                    <span class="option-meta">2â€“5 business days Â· $9.95</span>
                  </div>
                </label>
                <label class="option-card">
                  <input type="radio" name="delivery" value="express" data-fee="19.95">
                  <div>
                    <span class="option-title">Express Delivery</span>
                    <span class="option-meta">1â€“2 business days Â· $19.95</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="card">
              <h2>Payment Method</h2>
              <div class="option-list" id="payment-options">
                <label class="option-card">
                  <input type="radio" name="payment" value="bitcoin" checked>
                  <div>
                    <span class="option-title">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;color:#f7931a;"><circle cx="12" cy="12" r="10"/><path d="M9.5 7.5V9H8V11H9.5V16.5H11.5V11H13.5L14 9H11.5V7.8C11.5 7.36 11.72 7.15 12.22 7.15H14V5H12.22C10.24 5 9.5 6.06 9.5 7.5Z"/></svg>
                      Bitcoin
                      <span class="btc-discount-badge">15% OFF</span>
                    </span>
                    <span class="option-meta">Instant confirmation Â· Private &amp; secure Â· <strong style="color:#059669;">Save 15% when you pay with Bitcoin</strong></span>
                    <a href="/buy-bitcoin/" class="payment-info-link">Learn how to pay with Bitcoin &rarr;</a>
                  </div>
                </label>
                <label class="option-card">
                  <input type="radio" name="payment" value="bank">
                  <div>
                    <span class="option-title">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;color:var(--color-primary);"><rect x="3" y="10" width="18" height="11" rx="1"/><path d="M3 10l9-7 9 7"/></svg>
                      Bank Transfer
                    </span>
                    <span class="option-meta">PayID (instant) or BSB transfer Â· Zero fees</span>
                    <a href="/pay-with-bank-transfer/" class="payment-info-link">Learn how to pay with bank transfer &rarr;</a>
                  </div>
                </label>
                <label class="option-card">
                  <input type="radio" name="payment" value="paysafecard">
                  <div>
                    <span class="option-title">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;color:#00a3e0;"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/><path d="M6 15h4"/></svg>
                      Paysafecard
                    </span>
                    <span class="option-meta">Prepaid voucher Â· 16-digit PIN Â· Anonymous</span>
                    <a href="/pay-with-paysafecard/" class="payment-info-link">Learn how to pay with Paysafecard &rarr;</a>
                  </div>
                </label>
              </div>

              <div class="payment-panel" id="bitcoin-panel">
                <div class="panel-header">
                  <h3>Pay with Bitcoin <span class="btc-discount-badge">15% OFF Applied</span></h3>
                  <p>Scan the QR code or copy the address below. Your <strong>15% Bitcoin discount</strong> has been applied to the total.</p>
                </div>
                <div class="qr-layout">
                  <img class="qr-image" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=bitcoin:bc1q9u4m8xj6z2s8n3m5s2m9vte0y6q5k9w8v4w0v5" alt="Bitcoin payment QR code for Mullaways Medical Cannabis checkout" width="180" height="180" loading="lazy">
                  <div class="qr-details">
                    <div class="qr-field">
                      <span>Bitcoin Address</span>
                      <code>bc1q9u4m8xj6z2s8n3m5s2m9vte0y6q5k9w8v4w0v5</code>
                    </div>
                    <p class="helper">Send the exact total shown in your order summary.</p>
                    <a href="/buy-bitcoin/" style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;color:var(--color-primary);font-size:0.85rem;font-weight:600;text-decoration:underline;text-underline-offset:3px;">New to Bitcoin? Read our easy guide &rarr;</a>
                  </div>
                </div>
              </div>

              <div class="payment-panel" id="bank-panel" style="display: none;">
                <div class="panel-header">
                  <h3>Pay with Bank Transfer / PayID</h3>
                  <p>Our bank details and PayID will be sent to your email after you place your order.</p>
                </div>
                <div class="bank-info-notice">
                  <div class="notice-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8M8 14h5"/><path d="M4 8h16"/></svg>
                  </div>
                  <div>
                    <strong>How it works:</strong>
                    <ol style="margin:8px 0 0;padding-left:18px;font-size:0.9rem;color:#444;line-height:1.7;">
                      <li>Click <strong>"Place Order"</strong> below</li>
                      <li>You'll receive an email with our <strong>bank account details</strong> (BSB &amp; account number) and <strong>PayID</strong></li>
                      <li>Transfer the exact order amount using your banking app</li>
                      <li>Your order will be processed once payment is confirmed</li>
                    </ol>
                  </div>
                </div>
                <div class="info-alert" style="margin-top:14px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;margin-top:1px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                  <span>PayID transfers are <strong>instant 24/7</strong> â€” even on weekends. Standard BSB transfers take 1-2 hours during business days.</span>
                </div>
                <a href="/pay-with-bank-transfer/" style="display:inline-flex;align-items:center;gap:6px;margin-top:10px;color:var(--color-primary);font-size:0.85rem;font-weight:600;text-decoration:underline;text-underline-offset:3px;">Learn more about bank transfer payments &rarr;</a>
              </div>

              <div class="payment-panel" id="paysafecard-panel" style="display: none;">
                <div class="panel-header">
                  <h3>Pay with Paysafecard</h3>
                  <p>Enter your 16-digit Paysafecard PIN below to complete payment.</p>
                </div>
                <div class="psc-input-group">
                  <label for="psc-pin">Paysafecard PIN</label>
                  <input type="text" id="psc-pin" name="psc-pin" placeholder="0000-0000-0000-0000" maxlength="19" autocomplete="off" inputmode="numeric" pattern="[0-9\-\s]*" style="font-family:monospace;letter-spacing:2px;font-size:1.1rem;padding:14px 16px;border-radius:12px;border:1px solid #d8d8d8;width:100%;text-align:center;">
                  <span id="psc-pin-status" style="display:block;margin-top:6px;font-size:0.82rem;color:#666;">Enter the 16-digit code from your Paysafecard voucher</span>
                </div>
                <div class="info-alert" style="margin-top:14px;background:#e8f6fe;border-color:#a8d8f0;color:#0a5c82;">
                  Don't have a Paysafecard yet? Buy one at any newsagent, petrol station, or 7-Eleven with cash. <a href="/pay-with-paysafecard/" style="color:#0a5c82;font-weight:600;">Read our full guide &rarr;</a>
                </div>
              </div>
            </div>
          </div>

          <aside class="checkout-summary" id="checkout-summary">
            <div class="summary-card">
              <h3>Order Summary</h3>
              <div id="summary-items" class="summary-items"></div>
              <div class="summary-row">
                <span>Subtotal</span>
                <span id="summary-subtotal">$0.00</span>
              </div>
              <div class="summary-row">
                <span>Delivery</span>
                <span id="summary-shipping">$0.00</span>
              </div>
              <div class="summary-row summary-discount" id="summary-discount-row" style="display: none;">
                <span style="color:#059669;font-weight:600;">Bitcoin Discount (15%)</span>
                <span id="summary-discount" style="color:#059669;font-weight:600;">-$0.00</span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-row summary-total">
                <span>Total</span>
                <span id="summary-total">$0.00</span>
              </div>
              <button class="btn btn-primary btn-large btn-full" id="place-order-btn">Place Order</button>
              <p class="secure-note">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0110 0v4"/>
                </svg>
                Secure checkout with encrypted payment
              </p>
            </div>
          </aside>
        </div>

        <div class="empty-state" id="checkout-empty" style="display: none;">
          <div class="empty-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg></div>
          <h2>Your cart is empty</h2>
          <p>Add products to your cart before checking out.</p>
          <a href="/shop/" class="btn btn-primary">Browse Products</a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  .page-hero {
    position: relative;
    background: linear-gradient(135deg, var(--color-eucalyptus-dark) 0%, var(--color-eucalyptus) 100%);
    padding: var(--space-3xl) 0;
    text-align: center;
    overflow: hidden;
  }

  .hero-bg {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .hero-shape {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
  }

  .hero-shape-1 {
    width: 320px;
    height: 320px;
    top: -80px;
    right: -80px;
  }

  .hero-shape-2 {
    width: 240px;
    height: 240px;
    bottom: -60px;
    left: -60px;
  }

  .hero-content {
    position: relative;
    z-index: 1;
  }

  .section-label-light {
    color: rgba(255, 255, 255, 0.8);
  }

  .section-label-light::before {
    background: rgba(255, 255, 255, 0.5);
  }

  .page-hero h1 {
    color: white;
  }

  .page-hero p {
    color: rgba(255, 255, 255, 0.8);
  }

  .checkout-section {
    padding: 60px 0 90px;
    background: #fff;
  }

  .checkout-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(280px, 0.8fr);
    gap: 32px;
    align-items: start;
  }

  .card {
    background: #fff;
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.04);
    margin-bottom: 24px;
  }

  .card h2 {
    margin: 0 0 16px;
    font-size: 1.4rem;
    color: #1a1a1a;
  }

  .form-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full {
    grid-column: 1 / -1;
  }

  label {
    font-weight: 600;
    color: #1a1a1a;
  }

  input {
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #d8d8d8;
    font-size: 0.95rem;
  }

  .option-list {
    display: grid;
    gap: 12px;
  }

  .option-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px 16px;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .option-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.04);
  }

  .option-card input {
    margin: 0;
  }

  .option-title {
    display: block;
    font-weight: 600;
    color: #1a1a1a;
  }

  .option-meta {
    display: block;
    font-size: 0.85rem;
    color: #666;
  }

  .payment-panel {
    margin-top: 18px;
    padding: 18px;
    border-radius: 14px;
    background: #f9faf8;
    border: 1px solid var(--color-border);
  }

  .panel-header h3 {
    margin: 0 0 6px;
  }

  .panel-header p {
    margin: 0 0 16px;
    color: #666;
  }

  .qr-layout {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  .qr-image {
    width: 180px;
    height: 180px;
    border-radius: 12px;
    border: 1px solid #e2e2e2;
    background: #fff;
  }

  .qr-details {
    flex: 1;
    min-width: 180px;
  }

  .qr-field span {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 6px;
  }

  .qr-field code {
    display: block;
    font-size: 0.9rem;
    background: #fff;
    border: 1px solid #e2e2e2;
    padding: 10px 12px;
    border-radius: 10px;
    word-break: break-all;
  }

  .helper {
    margin-top: 10px;
    font-size: 0.85rem;
    color: #666;
  }

  .bank-details {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .bank-details span {
    display: block;
    font-size: 0.85rem;
    color: #666;
  }

  .bank-details strong {
    color: #1a1a1a;
  }

  .info-alert {
    background: #fff4e5;
    border: 1px solid #f0c88b;
    padding: 14px;
    border-radius: 12px;
    color: #5c3d06;
    font-size: 0.9rem;
  }

  .checkout-summary {
    position: sticky;
    top: 110px;
  }

  .summary-card {
    background: #fff;
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.05);
  }

  .summary-items {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    color: #555;
  }

  .summary-divider {
    height: 1px;
    background: #eee;
    margin: 16px 0;
  }

  .summary-total {
    font-weight: 700;
    color: #1a1a1a;
  }

  .secure-note {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #666;
    margin-top: 14px;
  }

  .empty-state {
    text-align: center;
    padding: 48px;
    border: 1px dashed #ddd;
    border-radius: 16px;
    margin-top: 24px;
  }

  .empty-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
  }

  @media (max-width: 960px) {
    .checkout-layout {
      grid-template-columns: 1fr;
    }

    .checkout-summary {
      position: static;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .bank-details {
      grid-template-columns: 1fr;
    }

    .qr-layout {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .qr-details {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .page-hero h1 {
      font-size: 1.75rem;
    }

    .card {
      padding: 16px;
    }

    .card h2 {
      font-size: 1.2rem;
    }

    .qr-image {
      width: 150px;
      height: 150px;
    }

    .option-card {
      padding: 12px;
    }

    .summary-card {
      padding: 16px;
    }
  }

  .payment-info-link {
    display: inline-block;
    margin-top: 4px;
    font-size: 0.78rem;
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 3px;
    font-weight: 600;
    transition: color 0.2s;
  }

  .payment-info-link:hover {
    color: var(--color-primary-dark);
  }

  .psc-input-group {
    margin-bottom: 8px;
  }

  .psc-input-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .bank-info-notice {
    display: flex;
    gap: 14px;
    padding: 16px;
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    color: #14532d;
  }

  .bank-info-notice .notice-icon {
    flex-shrink: 0;
    color: #16a34a;
    margin-top: 2px;
  }

  .bank-info-notice strong {
    font-size: 0.95rem;
  }

  .info-alert {
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  /* â”€â”€ Form Validation Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,0.12) !important;
  }

  .form-error {
    display: block;
    color: #dc2626;
    font-size: 0.78rem;
    margin-top: 4px;
    font-weight: 500;
    line-height: 1.3;
  }

  #place-order-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
  }

  #place-order-btn svg.spinner {
    display: inline-block;
    vertical-align: middle;
    margin-right: 6px;
  }

  .btc-discount-badge {
    display: inline-block;
    background: linear-gradient(135deg, #059669, #10b981);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 20px;
    margin-left: 8px;
    letter-spacing: 0.04em;
    vertical-align: middle;
    text-transform: uppercase;
  }
</style>

<script>
  // @ts-nocheck

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ EmailJS Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //
  // HOW TO SET UP EMAIL NOTIFICATIONS:
  //
  // 1. Sign up at https://www.emailjs.com (free tier: 200 emails/month)
  //
  // 2. Create an Email Service:
  //    - Go to "Email Services" â†’ "Add New Service"
  //    - Connect your Gmail, Outlook, or custom SMTP
  //    - Copy the Service ID (e.g. "service_abc123")
  //
  // 3. Create THREE email templates under "Email Templates":
  //
  //    Template 1: "Customer â€“ Order Confirmed" (for Paysafecard)
  //      Subject: "Order {{order_ref}} â€“ Confirmed âœ“"
  //      To Email: {{to_email}}
  //      Body: Use variables below (order_ref, to_name, items_list, etc.)
  //
  //    Template 2: "Customer â€“ Payment Pending" (for Bitcoin / Bank Transfer)
  //      Subject: "Order {{order_ref}} â€“ Awaiting Payment"
  //      To Email: {{to_email}}
  //      Body: Include payment_details variable for payment instructions
  //
  //    Template 3: "Admin â€“ New Order Notification"
  //      Subject: "ðŸ›’ New Order {{order_ref}} â€“ ${{total}}"
  //      To Email: SET YOUR ADMIN EMAIL DIRECTLY IN THE TEMPLATE
  //      Body: Use all variables below for full order details
  //
  //    Available template variables:
  //      {{to_email}}          â€“ Customer email (for customer templates)
  //      {{to_name}}           â€“ Customer full name
  //      {{order_ref}}         â€“ Order reference (e.g. MW-A1B2CDEF)
  //      {{order_date}}        â€“ Formatted date
  //      {{items_list}}        â€“ Line-by-line item list
  //      {{subtotal}}          â€“ Subtotal amount
  //      {{discount}}          â€“ Discount amount (if any)
  //      {{shipping}}          â€“ Shipping fee
  //      {{total}}             â€“ Total amount
  //      {{payment_method}}    â€“ Bitcoin / Bank Transfer / Paysafecard
  //      {{payment_details}}   â€“ Payment instructions
  //      {{shipping_address}}  â€“ Full delivery address
  //      {{delivery_method}}   â€“ Standard or Express
  //      {{customer_email}}    â€“ Customer email (for admin template)
  //      {{customer_phone}}    â€“ Customer phone (for admin template)
  //
  // 4. Copy each Template ID and paste below:
  //
  const EMAILJS_PUBLIC_KEY = '';                   // Your EmailJS public key (Account â†’ API Keys)
  const EMAILJS_SERVICE_ID = '';                   // Your EmailJS service ID
  const EMAILJS_TEMPLATE_CUSTOMER_PAID = '';       // Template: Customer â€“ Order Confirmed
  const EMAILJS_TEMPLATE_CUSTOMER_PENDING = '';    // Template: Customer â€“ Payment Pending
  const EMAILJS_TEMPLATE_ADMIN = '';               // Template: Admin â€“ New Order Notification
  //
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const cart = JSON.parse(localStorage.getItem('cart') || '[]')
    .filter((item) => item && item.name);

  const checkoutLayout = document.getElementById('checkout-layout');
  const checkoutEmpty = document.getElementById('checkout-empty');
  const summaryItems = document.getElementById('summary-items');
  const summarySubtotal = document.getElementById('summary-subtotal');
  const summaryShipping = document.getElementById('summary-shipping');
  const summaryTotal = document.getElementById('summary-total');
  const summaryDiscountRow = document.getElementById('summary-discount-row');
  const summaryDiscount = document.getElementById('summary-discount');
  const placeOrderBtn = document.getElementById('place-order-btn');
  const checkoutForm = document.getElementById('checkout-details');

  const bitcoinPanel = document.getElementById('bitcoin-panel');
  const bankPanel = document.getElementById('bank-panel');
  const paysafecardPanel = document.getElementById('paysafecard-panel');

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const BTC_DISCOUNT_RATE = 0.15; // 15% Bitcoin discount

  function getSelectedPayment() {
    const el = document.querySelector('input[name="payment"]:checked');
    return el instanceof HTMLInputElement ? el.value : 'bitcoin';
  }

  function getBtcDiscount(subtotal) {
    return getSelectedPayment() === 'bitcoin' ? Math.round(subtotal * BTC_DISCOUNT_RATE * 100) / 100 : 0;
  }

  function getShippingFee() {
    const selected = document.querySelector('input[name="delivery"]:checked');
    if (!(selected instanceof HTMLInputElement)) return 0;
    return Number(selected.dataset.fee || '0');
  }

  function generateOrderRef() {
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `MW-${timestamp.slice(-4)}${random}`;
  }

  function getFormValue(id) {
    const el = document.getElementById(id);
    return el instanceof HTMLInputElement ? el.value.trim() : '';
  }

  // â”€â”€ Render Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSummary() {
    if (!summaryItems || !summarySubtotal || !summaryShipping || !summaryTotal) return;

    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = getShippingFee();
    const discount = getBtcDiscount(subtotal);
    const total = subtotal + shipping - discount;

    summaryItems.innerHTML = cart.map((item) => `
      <div class="summary-item">
        <span>${item.name} &times; ${item.quantity}</span>
        <strong>$${(item.price * item.quantity).toFixed(2)}</strong>
      </div>
    `).join('');

    summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
    summaryShipping.textContent = `$${shipping.toFixed(2)}`;

    // Show/hide Bitcoin discount row
    if (summaryDiscountRow && summaryDiscount) {
      if (discount > 0) {
        summaryDiscountRow.style.display = 'flex';
        summaryDiscount.textContent = `-$${discount.toFixed(2)}`;
      } else {
        summaryDiscountRow.style.display = 'none';
      }
    }

    summaryTotal.textContent = `$${total.toFixed(2)}`;
  }

  // â”€â”€ Toggle Payment Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function togglePaymentPanels() {
    const selectedPayment = getSelectedPayment();

    if (bankPanel) bankPanel.style.display = selectedPayment === 'bank' ? 'block' : 'none';
    if (bitcoinPanel) bitcoinPanel.style.display = selectedPayment === 'bitcoin' ? 'block' : 'none';
    if (paysafecardPanel) paysafecardPanel.style.display = selectedPayment === 'paysafecard' ? 'block' : 'none';

    // Re-render summary to update Bitcoin discount
    renderSummary();
  }

  // â”€â”€ Validate Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateForm() {
    const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'state', 'postcode'];
    let firstError = null;
    let isValid = true;

    // Clear previous errors
    document.querySelectorAll('.form-error').forEach(el => el.remove());
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

    for (const fieldId of requiredFields) {
      const el = document.getElementById(fieldId);
      if (!(el instanceof HTMLInputElement)) continue;

      const value = el.value.trim();
      let error = '';

      if (!value) {
        error = 'This field is required';
      } else if (fieldId === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        error = 'Please enter a valid email address';
      } else if (fieldId === 'phone' && !/^[\d\s\+\-\(\)]{8,15}$/.test(value)) {
        error = 'Please enter a valid phone number';
      } else if (fieldId === 'postcode' && !/^\d{4}$/.test(value)) {
        error = 'Please enter a valid 4-digit postcode';
      }

      if (error) {
        isValid = false;
        el.classList.add('input-error');
        const errorEl = document.createElement('span');
        errorEl.className = 'form-error';
        errorEl.textContent = error;
        el.parentElement?.appendChild(errorEl);
        if (!firstError) firstError = el;
      }
    }

    // Paysafecard PIN validation
    const selectedPayment = document.querySelector('input[name="payment"]:checked');
    if (selectedPayment instanceof HTMLInputElement && selectedPayment.value === 'paysafecard') {
      const pinInput = document.getElementById('psc-pin');
      if (pinInput instanceof HTMLInputElement) {
        const pinDigits = pinInput.value.replace(/[^0-9]/g, '');
        if (pinDigits.length !== 16) {
          isValid = false;
          pinInput.classList.add('input-error');
          const errorEl = document.createElement('span');
          errorEl.className = 'form-error';
          errorEl.textContent = 'Please enter a valid 16-digit Paysafecard PIN';
          pinInput.parentElement?.appendChild(errorEl);
          if (!firstError) firstError = pinInput;
        }
      }
    }

    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }

    return isValid;
  }

  // â”€â”€ Load EmailJS SDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadEmailJS() {
    if (window.emailjs) return true;
    try {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
      window.emailjs.init(EMAILJS_PUBLIC_KEY);
      return true;
    } catch (err) {
      console.error('Failed to load EmailJS SDK:', err);
      return false;
    }
  }

  // â”€â”€ Build shared template params â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildTemplateParams(order) {
    const itemsList = order.items.map(i =>
      `${i.name} Ã— ${i.quantity} â€” $${(i.price * i.quantity).toFixed(2)}`
    ).join('\n');

    let paymentDetails = '';
    if (order.payment === 'bitcoin') {
      paymentDetails = `Bitcoin Address: bc1q9u4m8xj6z2s8n3m5s2m9vte0y6q5k9w8v4w0v5\nAmount: $${order.total.toFixed(2)} AUD\nReference: ${order.ref}`;
    } else if (order.payment === 'bank') {
      paymentDetails = `PayID: payments@mullawaysmedicalcannabis.com.au\nBSB: 062-000\nAccount: 1234 5678\nAccount Name: Mullaways Pty Ltd\nAmount: $${order.total.toFixed(2)} AUD\nReference: ${order.ref}`;
    } else if (order.payment === 'paysafecard') {
      paymentDetails = `Paysafecard PIN submitted for verification.\nAmount: $${order.total.toFixed(2)} AUD`;
    }

    return {
      to_email: order.customer.email,
      to_name: `${order.customer.firstName} ${order.customer.lastName}`,
      order_ref: order.ref,
      order_date: new Date(order.date).toLocaleDateString('en-AU', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      }),
      items_list: itemsList,
      subtotal: `$${order.subtotal.toFixed(2)}`,
      discount: order.discount > 0
        ? `-$${order.discount.toFixed(2)} (Bitcoin 15% discount)`
        : '$0.00',
      shipping: `$${order.shipping.toFixed(2)}`,
      total: `$${order.total.toFixed(2)}`,
      payment_method: order.payment === 'bitcoin' ? 'Bitcoin'
        : order.payment === 'bank' ? 'Bank Transfer'
        : 'Paysafecard',
      payment_details: paymentDetails,
      shipping_address: `${order.customer.address}, ${order.customer.city}, ${order.customer.state} ${order.customer.postcode}`,
      delivery_method: order.shippingMethod === 'express'
        ? 'Express (1â€“2 business days)'
        : 'Standard (2â€“5 business days)',
      customer_email: order.customer.email,
      customer_phone: order.customer.phone,
    };
  }

  // â”€â”€ Send Customer Confirmation Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendCustomerEmail(order) {
    const isPaid = order.payment === 'paysafecard';
    const templateId = isPaid ? EMAILJS_TEMPLATE_CUSTOMER_PAID : EMAILJS_TEMPLATE_CUSTOMER_PENDING;

    if (!templateId) {
      console.log('Customer email template not configured for payment type:', order.payment);
      return { success: false, reason: 'no_template' };
    }

    try {
      const params = buildTemplateParams(order);
      await window.emailjs.send(EMAILJS_SERVICE_ID, templateId, params);
      console.log('âœ“ Customer confirmation email sent to', order.customer.email);
      return { success: true };
    } catch (err) {
      console.error('Customer email failed:', err);
      return { success: false, reason: 'send_failed', error: err };
    }
  }

  // â”€â”€ Send Admin Notification Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendAdminEmail(order) {
    if (!EMAILJS_TEMPLATE_ADMIN) {
      console.log('Admin notification template not configured â€” skipping.');
      return { success: false, reason: 'no_template' };
    }

    try {
      const params = buildTemplateParams(order);
      await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, params);
      console.log('âœ“ Admin notification email sent for order', order.ref);
      return { success: true };
    } catch (err) {
      console.error('Admin notification email failed:', err);
      return { success: false, reason: 'send_failed', error: err };
    }
  }

  // â”€â”€ Send All Order Emails â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendOrderEmails(order) {
    if (!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID) {
      console.log('EmailJS not configured â€” skipping email notifications. Fill in EMAILJS_PUBLIC_KEY, EMAILJS_SERVICE_ID, and template IDs in checkout.astro to enable.');
      return { customer: { success: false, reason: 'not_configured' }, admin: { success: false, reason: 'not_configured' } };
    }

    const sdkLoaded = await loadEmailJS();
    if (!sdkLoaded) {
      return { customer: { success: false, reason: 'sdk_failed' }, admin: { success: false, reason: 'sdk_failed' } };
    }

    // Send both emails in parallel
    const [customerResult, adminResult] = await Promise.all([
      sendCustomerEmail(order),
      sendAdminEmail(order),
    ]);

    return { customer: customerResult, admin: adminResult };
  }

  // â”€â”€ Place Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function placeOrder() {
    // Validate form
    if (!validateForm()) return;

    // Gather data
    const selectedPayment = getSelectedPayment();

    const selectedDeliveryEl = document.querySelector('input[name="delivery"]:checked');
    const shippingMethod = selectedDeliveryEl instanceof HTMLInputElement ? selectedDeliveryEl.value : 'standard';
    const shippingFee = getShippingFee();

    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discount = getBtcDiscount(subtotal);
    const total = subtotal + shippingFee - discount;

    let pscPin = '';
    if (selectedPayment === 'paysafecard') {
      const pinInput = document.getElementById('psc-pin');
      if (pinInput instanceof HTMLInputElement) {
        pscPin = pinInput.value;
      }
    }

    const order = {
      ref: generateOrderRef(),
      date: new Date().toISOString(),
      items: cart.map(item => ({ name: item.name, price: item.price, quantity: item.quantity })),
      subtotal,
      shipping: shippingFee,
      shippingMethod,
      discount,
      total,
      payment: selectedPayment,
      pscPin,
      customer: {
        firstName: getFormValue('firstName'),
        lastName: getFormValue('lastName'),
        email: getFormValue('email'),
        phone: getFormValue('phone'),
        address: getFormValue('address'),
        city: getFormValue('city'),
        state: getFormValue('state'),
        postcode: getFormValue('postcode'),
      }
    };

    // Disable button and show loading
    if (placeOrderBtn) {
      placeOrderBtn.disabled = true;
      placeOrderBtn.innerHTML = `
        <svg class="spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" stroke-dasharray="31.4 31.4" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="0.8s" repeatCount="indefinite"/>
          </circle>
        </svg>
        Processing Order...
      `;
    }

    try {
      // Save order to localStorage
      localStorage.setItem('lastOrder', JSON.stringify(order));

      // Save to order history
      const orderHistory = JSON.parse(localStorage.getItem('orderHistory') || '[]');
      orderHistory.unshift(order);
      localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

      // Send confirmation emails (non-blocking â€” don't fail the order if email fails)
      sendOrderEmails(order).then(result => {
        if (result.customer.success) {
          console.log('âœ“ Customer confirmation email sent to', order.customer.email);
        } else {
          console.log('Customer email not sent:', result.customer.reason);
        }
        if (result.admin.success) {
          console.log('âœ“ Admin notification email sent for order', order.ref);
        } else {
          console.log('Admin email not sent:', result.admin.reason);
        }
      });

      // Clear the cart
      localStorage.removeItem('cart');

      // Dispatch cart update event for header badge
      window.dispatchEvent(new CustomEvent('cartUpdated'));

      // Small delay for UX â€” let user see "Processing..."
      await new Promise(resolve => setTimeout(resolve, 800));

      // Redirect to confirmation page
      window.location.href = `/order-confirmation?ref=${order.ref}`;

    } catch (err) {
      console.error('Order placement error:', err);
      if (placeOrderBtn) {
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = 'Place Order';
      }
      // Show inline error instead of alert
      let errorBanner = document.getElementById('order-error-banner');
      if (!errorBanner) {
        errorBanner = document.createElement('div');
        errorBanner.id = 'order-error-banner';
        errorBanner.style.cssText = 'background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:14px 18px;border-radius:12px;margin-top:14px;font-size:0.9rem;display:flex;align-items:center;gap:8px;';
        errorBanner.innerHTML = '<strong>Something went wrong.</strong> Please check your details and try again.';
        placeOrderBtn.parentElement?.appendChild(errorBanner);
      }
    }
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (cart.length === 0) {
    if (checkoutLayout) checkoutLayout.style.display = 'none';
    if (checkoutEmpty) checkoutEmpty.style.display = 'block';
  } else {
    renderSummary();
  }

  // Delivery change
  document.querySelectorAll('input[name="delivery"]').forEach((input) => {
    input.addEventListener('change', renderSummary);
  });

  // Payment change
  document.querySelectorAll('input[name="payment"]').forEach((input) => {
    input.addEventListener('change', togglePaymentPanels);
  });

  // Place Order button
  placeOrderBtn?.addEventListener('click', placeOrder);

  // Clear errors on input
  document.querySelectorAll('#checkout-details input').forEach((input) => {
    input.addEventListener('input', () => {
      input.classList.remove('input-error');
      const error = input.parentElement?.querySelector('.form-error');
      if (error) error.remove();
    });
  });

  // Paysafecard PIN: digits only, auto-format with dashes
  const pscPinInput = document.getElementById('psc-pin');
  const pscPinStatus = document.getElementById('psc-pin-status');
  if (pscPinInput instanceof HTMLInputElement) {
    pscPinInput.addEventListener('input', () => {
      let raw = pscPinInput.value.replace(/[^0-9]/g, '');
      if (raw.length > 16) raw = raw.slice(0, 16);
      const parts = [];
      for (let i = 0; i < raw.length; i += 4) {
        parts.push(raw.slice(i, i + 4));
      }
      pscPinInput.value = parts.join('-');
      // Clear error state
      pscPinInput.classList.remove('input-error');
      const error = pscPinInput.parentElement?.querySelector('.form-error');
      if (error) error.remove();
      // Status feedback
      if (pscPinStatus) {
        if (raw.length === 16) {
          pscPinStatus.textContent = '\u2713 Valid 16-digit PIN entered';
          pscPinStatus.style.color = '#059669';
          pscPinInput.style.borderColor = '#059669';
        } else if (raw.length > 0) {
          pscPinStatus.textContent = `${raw.length}/16 digits entered`;
          pscPinStatus.style.color = '#b45309';
          pscPinInput.style.borderColor = '#d8d8d8';
        } else {
          pscPinStatus.textContent = 'Enter the 16-digit code from your Paysafecard voucher';
          pscPinStatus.style.color = '#666';
          pscPinInput.style.borderColor = '#d8d8d8';
        }
      }
    });
    pscPinInput.addEventListener('keypress', (e) => {
      if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
        e.preventDefault();
      }
    });
    pscPinInput.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData)?.getData('text') || '';
      const digits = text.replace(/[^0-9]/g, '').slice(0, 16);
      pscPinInput.value = digits;
      pscPinInput.dispatchEvent(new Event('input'));
    });
  }
</script>
